<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Docs Preview</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Fira+Code:wght@400;500&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0d1117;
            --bg-secondary: #161b22;
            --bg-tertiary: #21262d;
            --border-color: #30363d;
            --text-primary: #e6edf3;
            --text-secondary: #8b949e;
            --text-muted: #6e7681;
            --accent: #58a6ff;
            --accent-hover: #79c0ff;
            --success: #3fb950;
            --code-bg: #1f2428;
            --sidebar-width: 220px;
            --toc-width: 200px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            margin-left: var(--sidebar-width);
            margin-right: var(--toc-width);
            min-height: 100vh;
        }

        /* Left Sidebar - Files */
        .sidebar-left {
            position: fixed;
            left: 0;
            top: 0;
            width: var(--sidebar-width);
            height: 100vh;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            z-index: 10;
        }

        .sidebar-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .file-list {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem 0;
        }

        .file-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-size: 0.85rem;
            color: var(--text-secondary);
            border-left: 2px solid transparent;
            transition: all 0.15s;
        }

        .file-item:hover {
            color: var(--text-primary);
            background: var(--bg-tertiary);
        }

        .file-item.active {
            color: var(--accent);
            border-left-color: var(--accent);
            background: rgba(88, 166, 255, 0.1);
        }

        /* Main Content */
        .main-content {
            width: 100%;
            min-height: 100vh;
        }

        .content-wrapper {
            max-width: 800px;
            margin: 0 auto;
            padding: 2rem 3rem;
            padding-bottom: 50vh;
            /* Extra space for scrolling */
        }

        /* Right Sidebar - TOC */
        .sidebar-right {
            position: fixed;
            right: 0;
            top: 0;
            width: var(--toc-width);
            height: 100vh;
            background: var(--bg-primary);
            border-left: 1px solid var(--border-color);
            overflow-y: auto;
            z-index: 10;
        }

        .toc-header {
            padding: 1rem;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
        }

        .toc-list {
            padding: 0 1rem 1rem;
        }

        .toc-item {
            display: block;
            padding: 0.3rem 0;
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-decoration: none;
            border-left: 2px solid var(--border-color);
            padding-left: 0.75rem;
            transition: all 0.15s;
        }

        .toc-item:hover {
            color: var(--text-primary);
        }

        .toc-item.active {
            color: var(--accent);
            border-left-color: var(--accent);
            font-weight: 500;
        }

        /* Markdown Styles - VitePress-like */
        #preview h1,
        #preview h2,
        #preview h3,
        #preview h4 {
            font-weight: 600;
            line-height: 1.25;
            scroll-margin-top: 1rem;
            position: relative;
        }

        #preview h1 {
            font-size: 2rem;
            margin: 0 0 1.5rem 0;
            letter-spacing: -0.02em;
        }

        #preview h2 {
            font-size: 1.5rem;
            margin: 2.5rem 0 1rem 0;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        #preview h3 {
            font-size: 1.25rem;
            margin: 2rem 0 0.75rem 0;
        }

        #preview h4 {
            font-size: 1.1rem;
            margin: 1.5rem 0 0.5rem 0;
        }

        /* Anchor links on headings */
        #preview h1 .header-anchor,
        #preview h2 .header-anchor,
        #preview h3 .header-anchor {
            color: var(--accent);
            text-decoration: none;
            margin-left: 0.25em;
            opacity: 0;
            transition: opacity 0.2s;
        }

        #preview h1:hover .header-anchor,
        #preview h2:hover .header-anchor,
        #preview h3:hover .header-anchor {
            opacity: 1;
        }

        #preview p {
            margin: 1rem 0;
            color: var(--text-primary);
            line-height: 1.7;
        }

        #preview strong {
            font-weight: 600;
            color: var(--text-primary);
        }

        #preview em {
            font-style: italic;
        }

        #preview a {
            color: var(--accent);
            text-decoration: none;
            font-weight: 500;
        }

        #preview a:hover {
            text-decoration: underline;
        }

        #preview code {
            font-family: 'Fira Code', monospace;
            background: rgba(110, 118, 129, 0.15);
            padding: 0.2em 0.4em;
            border-radius: 4px;
            font-size: 0.875em;
            color: var(--text-primary);
        }

        #preview pre {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1.25rem;
            margin: 1.25rem 0;
            overflow-x: auto;
            line-height: 1.6;
        }

        #preview pre code {
            background: none;
            padding: 0;
            color: var(--text-primary);
            font-size: 0.9rem;
        }

        #preview ul,
        #preview ol {
            margin: 1rem 0;
            padding-left: 1.25rem;
            line-height: 1.7;
        }

        #preview li {
            margin: 0.5rem 0;
            color: var(--text-primary);
        }

        #preview li::marker {
            color: var(--text-muted);
        }

        #preview blockquote {
            margin: 1rem 0;
            padding: 0.5rem 1rem;
            border-left: 4px solid var(--accent);
            background: rgba(88, 166, 255, 0.05);
            border-radius: 0 8px 8px 0;
        }

        #preview blockquote p {
            margin: 0;
            color: var(--text-secondary);
        }

        #preview hr {
            border: none;
            border-top: 1px solid var(--border-color);
            margin: 2rem 0;
        }

        /* Tables */
        #preview table {
            width: 100%;
            margin: 1rem 0;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        #preview th,
        #preview td {
            padding: 0.75rem 1rem;
            text-align: left;
            border: 1px solid var(--border-color);
        }

        #preview th {
            background: var(--bg-secondary);
            font-weight: 600;
            color: var(--text-primary);
        }

        #preview td {
            color: var(--text-primary);
        }

        #preview tr:hover td {
            background: rgba(255, 255, 255, 0.02);
        }

        /* Tip/Warning boxes */
        #preview .tip,
        #preview .warning,
        #preview .danger {
            margin: 1rem 0;
            padding: 1rem 1.25rem;
            border-radius: 8px;
            border-left: 4px solid;
        }

        #preview .tip {
            background: rgba(63, 185, 80, 0.1);
            border-color: var(--success);
        }

        #preview .warning {
            background: rgba(210, 153, 34, 0.1);
            border-color: #d29922;
        }

        #preview .danger {
            background: rgba(248, 81, 73, 0.1);
            border-color: #f85149;
        }

        /* Mermaid */
        .mermaid {
            background: var(--bg-secondary);
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1rem 0;
            display: flex;
            justify-content: center;
        }
    </style>
</head>

<body>
    <!-- Left Sidebar -->
    <aside class="sidebar-left">
        <div class="sidebar-header">
            <i class="fa-solid fa-book"></i> Docs
        </div>
        <nav class="file-list" id="file-list"></nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="content-wrapper">
            <div id="preview"></div>
        </div>
    </main>

    <!-- Right Sidebar -->
    <aside class="sidebar-right">
        <div class="toc-header">On This Page</div>
        <nav class="toc-list" id="toc-list"></nav>
    </aside>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';

        await document.fonts.ready;

        mermaid.initialize({
            startOnLoad: false,
            theme: 'dark',
            securityLevel: 'loose',
            flowchart: { htmlLabels: true }
        });

        let currentFile = '';
        let lastContent = '';
        let diagramId = 0;
        let files = [];

        // Extract H1 from markdown
        function extractH1(markdown) {
            const match = markdown.match(/^#\s+(.+)$/m);
            return match ? match[1] : null;
        }

        // Extract H2 headings from markdown
        function extractH2s(markdown) {
            const matches = [...markdown.matchAll(/^##\s+(.+)$/gm)];
            return matches.map(m => ({
                text: m[1],
                id: m[1].toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '')
            }));
        }

        // Load file list
        async function loadFileList() {
            // List of files in docs folder (sorted by filename)
            const knownFiles = ['docs/1.mermaid.md', 'docs/2.test.md', 'docs/mermaid.md'];
            files = [];

            for (const path of knownFiles) {
                try {
                    const response = await fetch(path);
                    if (response.ok) {
                        const content = await response.text();
                        const h1 = extractH1(content);
                        files.push({ path, title: h1 || path.split('/').pop().replace('.md', '') });
                    }
                } catch (e) { }
            }

            renderFileList();
            if (files.length > 0 && !currentFile) {
                selectFile(files[0].path);
            }
        }

        function renderFileList() {
            const list = document.getElementById('file-list');
            list.innerHTML = files.map(f => `
                <div class="file-item ${f.path === currentFile ? 'active' : ''}" data-path="${f.path}">
                    ${f.title}
                </div>
            `).join('');

            list.querySelectorAll('.file-item').forEach(item => {
                item.addEventListener('click', () => selectFile(item.dataset.path));
            });
        }

        function selectFile(path) {
            currentFile = path;
            lastContent = '';
            renderFileList();
            loadAndRender();
        }

        function renderTOC(h2s) {
            const toc = document.getElementById('toc-list');
            toc.innerHTML = h2s.map(h => `
                <a class="toc-item" href="#${h.id}">${h.text}</a>
            `).join('');
        }

        async function loadAndRender() {
            if (!currentFile) return;

            try {
                const response = await fetch(currentFile + '?t=' + Date.now());
                const markdown = await response.text();

                if (markdown === lastContent) return;
                lastContent = markdown;

                // Extract H2s for TOC
                const h2s = extractH2s(markdown);
                renderTOC(h2s);

                // Replace mermaid blocks
                const processed = markdown.replace(/```mermaid\s*([\s\S]*?)```/g, (_, code) => {
                    const id = `mermaid-${diagramId++}`;
                    return `<div class="mermaid" id="${id}">${code.trim()}</div>`;
                });

                // Custom renderer to add IDs and anchor links to headings
                const renderer = new marked.Renderer();
                renderer.heading = function (data) {
                    // Handle both old (text, level) and new (data object) API
                    const text = typeof data === 'string' ? data : data.text;
                    const level = typeof data === 'string' ? arguments[1] : data.depth;
                    const id = text.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
                    return `<h${level} id="${id}">${text} <a class="header-anchor" href="#${id}">#</a></h${level}>`;
                };

                document.getElementById('preview').innerHTML = marked.parse(processed, { renderer });

                // Render mermaid diagrams
                const mermaidDivs = document.querySelectorAll('.mermaid');
                for (const div of mermaidDivs) {
                    const code = div.textContent;
                    div.textContent = '';
                    try {
                        const { svg } = await mermaid.render(`svg-${div.id}`, code);
                        div.innerHTML = svg;
                    } catch (err) {
                        div.innerHTML = `<pre style="color:#f85149">Error: ${err.message}</pre>`;
                    }
                }
            } catch (error) {
                console.error('Error:', error);
            }
        }

        await loadFileList();
        setInterval(loadAndRender, 300);

        // Scroll spy - highlight active TOC item based on scroll position
        function updateActiveTOC() {
            const headings = document.querySelectorAll('#preview h2[id]');
            const tocItems = document.querySelectorAll('.toc-item');

            if (headings.length === 0) return;

            let activeId = '';
            const scrollTop = window.scrollY;
            const offset = 100; // Offset from top to trigger active state

            for (const heading of headings) {
                if (heading.offsetTop - offset <= scrollTop) {
                    activeId = heading.id;
                }
            }

            // If scrolled past the last heading, keep it active
            if (!activeId && headings.length > 0) {
                activeId = headings[0].id;
            }

            tocItems.forEach(item => {
                const href = item.getAttribute('href');
                if (href === `#${activeId}`) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }

        window.addEventListener('scroll', updateActiveTOC);
        updateActiveTOC();
    </script>
</body>

</html>